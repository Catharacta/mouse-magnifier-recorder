# 画面録画アプリ（Electron・Windows） — 機能要件（反映済み）

## 概要
Electron（Chromium）ベースのWindows専用アプリ。画面（全画面 / ウィンドウ / 指定モニタ）を録画し、録画中にユーザがマウス位置を中心にホイール＋修飾キーでズーム操作を行える。ズーム／パン操作を時刻付きメタ情報（JSON）として記録し、録画終了後にそのメタ情報を適用して最終動画（WebM / MP4）を出力する。

---

## 反映済み前提（ユーザ回答）
1. MP4（H.264）対応は商用利用可能なやり方で実装する。  
2. システム音声は機能として必須。ただし録画時に録音しない選択を可能とする。  
3. 優先品質ターゲットは 1080p / 30fps 。

---

## 短い結論（要点）
- 出力フォーマット：WebM（VP8/VP9 + Opus）と MP4（H.264 + AAC）を両対応。  
- 商用配布対応（H.264）：商用で安定提供するため、ネイティブエンコーダ（Windows Media Foundation 等）を使って H.264/AAC を生成し MP4 に mux する方式を推奨。Electron の proprietary codecs ビルドを使うオプションもサポート可能だが、配布・ライセンス方針の確認が必要。  
- システム音声：機能として必須。UI でオン/オフ切替可。録画時に録音しない選択も可能。  
- デフォルト品質：1080p / 30fps を標準とする。

---

## 実装方針（技術的決定）
1. 録画キャプチャ（レンダラ）
   - 画面取得：`navigator.mediaDevices.getDisplayMedia()`  
   - 録画（原本）：`MediaRecorder`（初期は WebM を直接出力）  
   - 録画中ズーム：レンダラでホイール＋修飾キー（既定: Ctrl）で即時プレビューを描画。イベントを `metadata.json` に記録（`time_ms`, `center`, `scale`, `duration`, `easing`）。

2. ポストプロセス（エクスポート）
   - WebM 出力（確実パス）：
     - 簡易 PoC: `<video>` 再生 → `OffscreenCanvas` / WebGL でフレーム毎に transform → `canvas.captureStream()` を `MediaRecorder` で再録画 → final WebM  
     - 高品質: `WebCodecs` の `VideoDecoder` → GPU transform → `VideoEncoder` (VP9/VP8) → WebM mux（JS ライブラリ等）
   - MP4 出力（商用対応パス）：
     - 推奨：ネイティブ側（main process のネイティブモジュール）で Windows Media Foundation を使い H.264 エンコード + AAC エンコード → MP4 に mux。ブラウザと IPC/共有メモリでフレームをやり取り。  
     - 代替：Electron の proprietary codecs 有効ビルドを配布し、ブラウザ側の H.264 エンコーダを利用する（事前に利用可否を確認）。
   - 音声：原本のタイムスタンプを保って再エンコード後に正確に mux。

3. システム音声取得
   - マイク：renderer の `getUserMedia` で取得可能。  
   - システム音声：Windows の WASAPI ループバックを main/native で取得し、エクスポート時に映像と同期して mux。  
   - UI で「マイク」「システム音声」を個別 ON/OFF。両方同時選択可能。

---

## UI / 設定（ユーザ向け）
- デフォルト録画プロファイル
  - 解像度：1080p（1920×1080）  
  - fps：30  
  - 出力プリセット：WebM 高品質 / WebM 互換 / MP4 標準（H.264）  
  - 音声：マイク ON/OFF、システム音声 ON/OFF（初期: マイク ON、システム音声 OFF）
- 録画中
  - HUD：REC、経過時間、現在倍率、イベントカウンタ  
  - 操作：Ctrl + Wheel = ズーム、Shift = 微調整、M = 手動イベント追加  
  - 録画中に「録音しない」オプションを即時切替可能
- 録画後
  - タイムライン / イベント一覧で編集（時間/位置/scale/duration/easing）  
  - プレビュー（編集反映を確認）  
  - エクスポート（フォーマット・プリセット選択、保存先）  
  - エクスポート進捗とキャンセル

---

## 推奨ビットレートの目安（1080p/30fps）
- WebM (VP9) 高品質プリセット: VBR 6–12 Mbps（用途により調整）  
- MP4 (H.264) 標準プリセット: 6–10 Mbps（品質優先なら上げる）

---

## マイルストーン（商用対応を踏まえた順序）
- M1 (PoC, 早期): `getDisplayMedia` + `MediaRecorder` で WebM 録画。ズームイベントを `metadata.json` に記録。1080p/30fps の GUI と HUD。  
- M2: `OffscreenCanvas` による再録画で metadata を適用した WebM 出力（簡易エクスポート）。イベント編集 UI の最小実装。  
- M3: `WebCodecs` を使ったデコード→GPU transform→`VideoEncoder`（VP9/VP8）による WebM パスの実装。  
- M4 (商用 MP4 実装): ネイティブ側（Media Foundation）を用いた H.264/AAC エンコード & MP4 mux の追加。WASAPI によるシステム音声取得を統合。  
- M5: UI 磨き、プロファイル保存、インストーラ作成、総合テスト（音声同期・DPI/マルチモニタテスト等）

---

## リスクと対応（要注意点）
- MP4(H.264) をブラウザ側だけで確実に提供するのは Electron のビルド依存。商用で安定させるには「ネイティブ (Media Foundation) 実装」を推奨する。  
- 長時間・高解像度の再エンコードは CPU/GPU 負荷が大きい → エクスポート進捗とキャンセル、バックグラウンド処理設計を必須にする。  
- システム音声の取り扱いはネイティブ実装が必要（WASAPI）。ユーザへ OSレベルの許可や排他モードの注意を案内する UI を用意する。

---

## 次に決めるべき項目（開発着手前）
1. MP4 実装方針の最終決定：  
   - A: ネイティブ（Media Foundation）での H.264/AAC + MP4 mux を採用（推奨：商用配布で安定）。  
   - B: Electron の proprietary codecs 有効ビルドを採用してブラウザ側で H.264 を使う（ビルド・配布ポリシー確認が必要）。  
2. システム音声の取得方法の確定（必須機能なので WASAPI 実装を行うか）。  
3. 優先マイルストーン：まず PoC（M1/M2）で早めに動作確認を行うか、M4 を先に着手するか。

---

## 内部API（IPC / 関数）
- `startRecording(config) -> { sessionId }`  
- `stopRecording(sessionId) -> { rawVideoPath, metadataPath }`  
- `recordZoomEvent(sessionId, event) -> OK`  
- `exportSession(sessionId, { format: "webm" | "mp4", preset: "high"|"fast", outputPath }, progressCallback) -> finalFilePath`  
- `getStatus(sessionId) -> { state, recordedDuration, eventsCount }`

---

## データフロー（高レベル）
1. 録画開始
   - renderer: `getDisplayMedia()` -> `mediaStream`  
   - renderer: 必要なら音声（`getUserMedia`）を統合 -> `recorderStream`  
   - renderer: `MediaRecorder(recorderStream)` -> 原本 WebM を生成  
   - renderer: ズーム入力で metadata を更新（IPC で main に永続化）  
2. 録画終了
   - renderer: 原本 WebM と `metadata.json` を確定  
3. エクスポート（選択）
   - WebM (quick): 原本を再生 -> `OffscreenCanvas` で transform -> `captureStream()` -> `MediaRecorder` -> final WebM  
   - WebM (高品質): `WebCodecs` decode -> GPU transform -> `VideoEncoder`(VP9/VP8) -> WebM mux -> final WebM  
   - MP4: ブラウザ H.264 が利用可なら `WebCodecs` の H.264 encoder 経由で MP4 mux、不可ならネイティブ側で H.264/AAC によるエンコード+MP4 mux

---

## テスト要件
- 単体テスト
  - metadata の読み書き、補間ロジック、座標系（DPI/マルチモニタ）の正規化
- 結合テスト
  - 短時間録画 -> イベント記録 -> 編集 -> 出力（WebM/MP4） -> 再生による視覚確認と音声同期
- パフォーマンステスト
  - 1080p/30fps（および 60fps）での録画中フレームドロップ率、エクスポート時間、メモリ/ディスク使用量
- Electron ビルドテスト
  - H.264 エンコーダの可用性チェック（配布バイナリごとに確認）

---

## ロギング / エラー処理
- キャプチャ失敗（権限拒否など）、ディスク不足、エンコード失敗は UI で通知  
- エクスポート中は進捗・残り時間・キャンセルを提供  
- エラー時はログを保存してユーザに復旧案内を表示

---